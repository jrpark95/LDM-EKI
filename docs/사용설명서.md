# LDM-CRAM7 사용설명서

## 개요

LDM-CRAM7은 라그랑지안 입자 분산 모델(Lagrangian Dispersion Model)과 CRAM(Chebyshev Rational Approximation Method)을 결합한 핵종 확산 시뮬레이션 시스템입니다. 이 시스템은 60개의 핵종에 대한 방사성 붕괴와 딸핵종 생성을 정확하게 계산하며, 대기 중에서의 입자 확산을 시뮬레이션합니다.

## 시스템 요구사항

### 하드웨어
- NVIDIA GPU (CUDA Compute Capability 6.1 이상)
- 최소 8GB RAM
- 10GB 이상의 저장 공간

### 소프트웨어
- Ubuntu 18.04 이상
- CUDA Toolkit 11.0 이상
- GCC 7.0 이상
- Python 3.6 이상 (시각화용)
- Required Python packages: numpy, pandas, matplotlib, seaborn

## 설치 및 컴파일

### 1. 소스 코드 준비
```bash
cd /path/to/LDM-CRAM7
```

### 2. 컴파일
```bash
make clean
make
```

컴파일이 성공하면 실행 파일 `ldm`이 생성됩니다.

## 입력 파일 구성

### 필수 입력 파일들

#### 1. 핵종 설정 파일 (`data/input/nuclides_config_60.txt`)
60개 핵종의 붕괴 상수와 초기 농도비를 정의합니다.
```
Co-58,-1.134E-07,1.0
Co-60,-4.168E-09,1.0
Kr-85,-2.049E-09,1.0
...
```
형식: `핵종명,붕괴상수(/s),농도비`

#### 2. 소스 설정 파일 (`data/input/source.txt`)
방출원 위치와 격자 설정을 정의합니다.
```
[GRID_CONFIG]
start_lat: 36.0
start_lon: 140.0
end_lat: 37.0
end_lon: 141.0
lat_step: 0.5
lon_step: 0.5

[SOURCE]
140.5 37.0 100.0

[SOURCE_TERM]
1 1.00281e-6 1.0e-3

[RELEASE_CASES]
1 1 1.00
```

#### 3. 물리 모델 설정 파일 (`data/input/setting.txt`)
난류, 건식침적, 습식침적, 방사성붕괴 모델의 활성화/비활성화를 설정합니다.
```
# Physics model switches (0=off, 1=on)
TURB 0        # 난류 모델
DRYDEP 1      # 건식 침적
WETDEP 0      # 습식 침적  
RADDECAY 1    # 방사성 붕괴
```

#### 4. 기상 데이터 파일들 (`data/input/flexprewind/`)
- `0.txt, 1.txt, ...`: 시간별 기상 데이터 (바이너리 포트란 형식)
- `hgt_0.txt, hgt_1.txt, ...`: 고도 데이터

#### 5. CRAM 행렬 파일 (`cram/A60.csv`)
60×60 CRAM 전이 행렬로, 핵종 간 붕괴 체인을 정의합니다.

## 실행 방법

### 1. 기본 실행
```bash
./run.sh
```

또는 직접 실행:
```bash
./ldm
```

### 2. 실행 과정
시뮬레이션은 다음 단계로 진행됩니다:

1. **초기화 단계**
   - 핵종 설정 로드
   - CRAM 시스템 초기화
   - 입자 초기화

2. **기상 데이터 로드**
   - 고도 데이터 로드 (`loadFlexHeightData()`)
   - 기상 데이터 로드 (`initializeFlexGFSData()`)
   - GPU 메모리 할당

3. **시뮬레이션 실행**
   - 입자 이동 계산
   - 핵종 붕괴 계산 (CRAM)
   - 결과 저장

## 출력 결과

### 1. VTK 파일들 (`output/`)
각 시간 단계별로 생성되는 3D 시각화 파일들:
- `plot_00001.vtk` ~ `plot_XXXXX.vtk`
- ParaView 등의 소프트웨어로 열어볼 수 있음

### 2. 검증 데이터 (`validation/`)
- `nuclide_totals.csv`: 핵종별 총 농도 변화
- `first_particle_concentrations.csv`: 첫 번째 입자의 농도 추적
- `concentration_grid_XXXXX.csv`: 격자별 농도 분포

### 3. 시각화 결과 (`cram_result/`)
- `all_60_nuclides_grid.png`: 60개 핵종 농도 변화 그래프
- `ldm_stacked.png`: 적층 영역 플롯
- `ldm_heatmap.png`: 히트맵 시각화
- `simulation_summary.csv`: 종합 통계 데이터

## 주요 설정 매개변수

### 시뮬레이션 매개변수 (소스 코드 내)
```cpp
// 입자 수
int numberOfParticles = 10000;

// 시간 단계
float timeStep = 10.0;  // 초

// 총 시뮬레이션 시간
int totalTimeSteps = 7200;  // 20시간

// 격자 크기
int dimX_GFS = 361;
int dimY_GFS = 181; 
int dimZ_GFS = 26;
```

### 물리 모델 매개변수
- **난류 계수**: 대기 난류에 의한 확산 계산
- **침적 속도**: 건식/습식 침적률
- **방출률**: 소스항에서의 방출률

## 문제 해결

### 일반적인 오류들

#### 1. 컴파일 오류
```bash
# CUDA 경로 확인
echo $CUDA_PATH
which nvcc

# Makefile에서 CUDA 경로 수정
```

#### 2. 실행 시 NaN 오류
- **원인**: 기상 데이터 로딩 순서 문제
- **해결**: `loadFlexHeightData()`가 `initializeFlexGFSData()`보다 먼저 실행되는지 확인

#### 3. GPU 메모리 부족
```bash
# GPU 메모리 확인
nvidia-smi

# 입자 수 줄이기 (소스 코드 수정)
numberOfParticles = 5000;  // 기본값 10000에서 감소
```

#### 4. 기상 데이터 파일 없음
```bash
# 파일 존재 확인
ls -la data/input/flexprewind/

# 파일 권한 확인
chmod 644 data/input/flexprewind/*
```

### 디버그 모드 실행
```bash
# 디버그 정보와 함께 컴파일
make clean
make DEBUG=1

# 상세 로그와 함께 실행
./ldm 2>&1 | tee simulation.log
```

## 결과 분석

### 1. 농도 변화 분석
```python
import pandas as pd
import matplotlib.pyplot as plt

# 핵종별 농도 데이터 로드
data = pd.read_csv('validation/first_particle_concentrations.csv')

# 특정 핵종 농도 변화 플롯
plt.figure(figsize=(10, 6))
plt.plot(data['Time'], data['I-131'], label='I-131')
plt.plot(data['Time'], data['Cs-137'], label='Cs-137')
plt.xlabel('시간 (초)')
plt.ylabel('농도')
plt.legend()
plt.show()
```

### 2. 공간 분포 분석
VTK 파일들을 ParaView로 열어서 3D 농도 분포를 확인할 수 있습니다.

### 3. 통계 분석
`cram_result/simulation_summary.csv` 파일에서 각 핵종별 통계 정보를 확인할 수 있습니다:
- 초기/최종 농도
- 최대/최소 농도
- 평균 및 표준편차
- 반감기 정보

## 고급 사용법

### 1. 새로운 핵종 추가
1. `data/input/nuclides_config_60.txt`에 핵종 정보 추가
2. `cram/A60.csv`에서 행렬 크기 확장
3. 소스 코드에서 `N_NUCLIDES` 상수 수정

### 2. 물리 모델 수정
- `src/kernels/ldm_kernels.cuh`: 입자 이동 및 물리 계산
- `src/include/ldm_cram2.cuh`: CRAM 핵종 붕괴 계산

### 3. 출력 형식 변경
- `src/include/ldm_plot.cuh`: VTK 출력 형식 수정
- 새로운 출력 형식 추가 가능

## 성능 최적화

### 1. GPU 최적화
- 입자 수 조정으로 GPU 메모리 사용량 최적화
- CUDA 블록 크기 조정

### 2. 시간 단계 최적화
- 정확도와 계산 시간의 균형 조정
- 적응적 시간 단계 사용 고려

### 3. 메모리 최적화
- 불필요한 중간 결과 저장 최소화
- 데이터 압축 고려

## 지원 및 문의

시스템 사용 중 문제가 발생하거나 추가 기능이 필요한 경우, 다음 정보와 함께 문의하시기 바랍니다:

1. 시스템 환경 정보 (GPU 모델, CUDA 버전 등)
2. 오류 메시지 전문
3. 사용한 입력 파일들
4. 시뮬레이션 로그 파일

이 사용설명서는 LDM-CRAM7 v1.0 기준으로 작성되었습니다.